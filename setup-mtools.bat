@echo off

>nul 2>&1 "%SYSTEMROOT%\system32\cacls.exe" "%SYSTEMROOT%\system32\config\system"
if '%errorlevel%' NEQ '0' (
	echo You must run the script with admin rights...
	pause > nul
    exit /B    
) 

CD /D "%~dp0"
echo ===================================
echo           mtools setup
echo ===================================
echo.

::-- CHECK FOR DEPENDENCIES

IF NOT DEFINED MTOOLS_DEPENDENCIES_PATH (
echo ************* ERROR ***************
echo This script must be run AFTER running 'setup-mtools-dependencies.bat'. 
echo Aborting...
echo ***********************************
	pause > nul
	exit /b
)

::-- SET THE ENVIRONMENT VARIABLE

echo.
echo [Setting the global environment variables MTOOLS_LIB....]
echo on
setx /m MTOOLS_LIB "%CD%\\" 
@echo off


::-- ASK FOR SSE SUPPORT

echo.
echo [SSE support]
:loopchoiceSSE
echo.
set /p ssesupport="Do you want to enable SSE instruction set support (Y/N) ? " 
echo.
if "%ssesupport%" equ "Y" (
	set use_sse=y
	goto:makeconfig
	)
if "%ssesupport%" equ "y" (
	set use_sse=y
	goto:makeconfig
	)
if "%ssesupport%" equ "N" (
	set use_sse=n
	goto:makeconfig
	)
if "%ssesupport%" equ "n" (
	set use_sse=n
	goto:makeconfig
	)
echo "Invalid choice."
goto :loopchoiceSSE

	
:makeconfig	

::-- CREATE mtools_config.hpp

echo [Creating the configuration file 'mtools_config.hpp']
echo. 
echo /**************************************************************  1>  ./mtools/headers/mtools_config.hpp
echo  *               MTOOLS CONFIGURATION FILE                    *  1>>  ./mtools/headers/mtools_config.hpp
echo  *                                                            *  1>>  ./mtools/headers/mtools_config.hpp
echo  * This file is automatically generated.                      *  1>> ./mtools/headers/mtools_config.hpp
echo  * Run the script 'setup-mtools' to update the configuration. *  1>> ./mtools/headers/mtools_config.hpp
echo  **************************************************************/ 1>>  ./mtools/headers/mtools_config.hpp
call:newline
echo ^#pragma once 1>>  ./mtools/headers/mtools_config.hpp
call:newline
call:newline

set /p MTOOLSVERSION=<./VERSION
echo ^#define MTOOLS_VERSION %MTOOLSVERSION%    1>>  ./mtools/headers/mtools_config.hpp
call:newline

if %use_sse% equ y (
	echo // SSE instruction set support ENABLED  1>> ./mtools/headers/mtools_config.hpp
	echo ^#define MTOOLS_USE_SSE                 1>> ./mtools/headers/mtools_config.hpp
	)
if not %use_sse% equ y (
	echo // SSE instruction set support DISABLED 1>> ./mtools/headers/mtools_config.hpp
	echo //^#define MTOOLS_USE_SSE               1>> ./mtools/headers/mtools_config.hpp
	)
call:newline
		
::-- ADD OPENCL CONFIG FILE
		
type "%OPENCL_LIB%\mtools_config_opencl.txt"     1>> ./mtools/headers/mtools_config.hpp

:: -- END OF mtools_config.hpp
echo /^* end of mtools_config.hpp ^*/            1>> ./mtools/headers/mtools_config.hpp
call:newline


::-- FINISHED 
echo.
echo.
echo Configuration complete.
pause > nul
exit /b


::-- add a newline to the configuration file. 
:newline
echo. 1>> ./mtools/headers/mtools_config.hpp
goto:eof



